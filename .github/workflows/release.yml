name: "Release"

on:
  workflow_run:
    workflows: ["Build Test"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  fetch-assets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Fetch Assets
        working-directory: apps/client
        run: |
          bun install
          npm run fetch:ffmpeg
          npm run fetch:models
      - name: Save assets cache
        uses: actions/cache/save@v4
        with:
          path: |
            apps/client/src-tauri/binaries
            apps/client/src-tauri/models
          key: assets-${{ hashFiles('apps/client/scripts/**') }}

  release:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.outputs.outputs.release-id }}
      version: ${{ steps.outputs.outputs.version }}
      new_release_published: ${{ steps.outputs.outputs.new_release_published }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: apps/client
        run: npm install

      - name: Run Semantic Release
        id: semantic
        working-directory: apps/client
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release

      - name: Get Release Outputs
        id: outputs
        working-directory: apps/client
        run: |
          VERSION=$(grep -o '"version": "[^"]*"' package.json | cut -d'"' -f4)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          
          # Check if a tag points to HEAD, indicating a new release
          if git describe --tags --exact-match HEAD >/dev/null 2>&1; then
            echo "new_release_published=true" >> "$GITHUB_OUTPUT"
          else
            echo "new_release_published=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download Benchmark Report
        if: steps.outputs.outputs.new_release_published == 'true'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-test.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: compression-report
          path: benchmark-report

      - name: Append Benchmark to Release
        if: steps.outputs.outputs.new_release_published == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.outputs.outputs.version }}"
          REPORT_FILE="benchmark-report/compression_report.md"
          if [ -f "$REPORT_FILE" ]; then
            echo -e "\n\n## Compression Benchmark Results\n" >> release_notes.md
            cat "$REPORT_FILE" >> release_notes.md
            gh release edit "v$VERSION" --notes-file release_notes.md --append
          else
            echo "Benchmark report not found."
          fi

  publish-tauri:
    needs: [release, fetch-assets]
    if: needs.release.outputs.new_release_published == 'true'
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
            args: "--target universal-apple-darwin"
            target: "universal-apple-darwin"
          - platform: "ubuntu-22.04"
            args: "--bundles deb"
            target: "x86_64-unknown-linux-gnu"
          - platform: "ubuntu-22.04"
            args: "--target aarch64-unknown-linux-gnu --bundles deb,appimage"
            target: "aarch64-unknown-linux-gnu"
          - platform: "ubuntu-24.04"
            args: "--bundles appimage,rpm"
            target: "x86_64-unknown-linux-gnu"
          - platform: "windows-latest"
            args: ""
            target: "x86_64-pc-windows-msvc"
          - platform: "windows-11-arm"
            args: "--target aarch64-pc-windows-msvc"
            target: "aarch64-pc-windows-msvc"

    uses: ./.github/workflows/build.yml
    with:
      platform: ${{ matrix.platform }}
      target: ${{ matrix.target }}
      build-args: ${{ matrix.args }}
      sign-binaries: true
      asset-prefix: "boreal"
      upload-artifacts: false
      use-asset-cache: true
      release-id: ${{ needs.release.outputs.version }} # Use version as release ref since SR tags it
    secrets: inherit
